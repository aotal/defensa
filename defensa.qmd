---
title: Soluciones para la reconstrucción de aplicadores ginecológicos en braquiterapia sobre MRI
author: "[Antonio Otal Palacín](aotalpalacin@gmail.com)"
lang: es
format: 
    revealjs:
        logo: logo.png
        css: styles.css
        number-sections: false
        slide-number: false
        center: false
        preview-links: true
        include-in-header:
            text: 
                <script type="text/javascript" src="https://unpkg.io/itk-vtk-viewer@9.14.1/dist/itkVtkViewerCDN.js"></script>
        title-slide-attributes:
            data-background-image: logo.png
            data-background-size: 45% 
            data-background-opacity: "0.05"
            data-background-color: "white"
        date-format: "[Valencia, ] DD [de] MMMM [de] YYYY"
        date: 05/24/2024
jupyter: python3
---

# Índice

- Introducción
- *Dummies*
- Bibliotecas de aplicadores
- Publicaciones
- Discusión general
- Conclusiones

# Introducción

::: notes
Notes
:::

## Cáncer de cuello uterino

![](img/EstadisticaCCervix.jpg)

::: notes
- Tercer cáncer más frecuente en mujeres
- No hablaremos del resto de tumores ginecológicos, aunque son exportables algunas de la metodologías expuestas
:::





## Esquema de tratamiento {auto-animate="true"}

 Enfermedad localmente avanzada (FIGO IB2-IV4)[^1]

 Radioterapia externa de la zona pélvica

 Quimioterapia concurrente

 Braquiterapia


[^1]: Estas etapas implican una extensión más significativa del tumor, pudiendo abarcar desde lesiones visibles en el cuello uterino hasta la invasión de áreas más allá del útero, como la pared pélvica, la vagina inferior o incluso la mucosa de la vejiga o el recto (ICRU89)



::: notes
Recordar que hablaremos de braquiterapia menos en el artículo 3
:::

## Esquema de tratamiento {auto-animate="true"}

::: {style="margin-top: 200px; font-size: 2em; color: red;"}
Braquiterapia
:::

## ICRU89 {.center}

::: columns

::: {.column width="20%"}
![](img/logoicru.png)
:::

::: {.column width="80%"}

### ICRU Report 89, Prescribing, Recording, and Reporting Brachytherapy for Cancer of the Cervix

:::

:::



::: notes

:::

## Imagen en BT de cérvix {auto-animate="true"}

Ultrasonidos

Tomografía por emisión de positrones (PET/CT)

Tomografía Computarizada

Resonancia Magnética Nuclear


::: notes

:::

## Imagen en BT de cérvix {auto-animate="true"}

::: {style="margin-top: 200px; font-size: 2em; color: red;"}
Tomografía Computarizada

Resonancia Magnética Nuclear
:::

## Tomografía Computarizada

- El CT es una modalidad de imagen ampliamente utilizada en BT ginecológica para el tratamiento de tumores cervicales
- Permite delinear los OAR de forma comparable a la MRI
- Su uso está muy extendido y los Oncólogos radioterápicos están familiarizados con su interpretación.
- Limitación es el contraste relativamente bajo de los tejidos blandos en comparación con la MRI

::: notes

:::

## Resonancia Magnética Nuclear

::: rows

::: {.row width="50%" style="display: inline-block; border: 1px solid black; padding: 5px;"}
![](img/MRIMandatory.png){width="70%"}
:::

::: {.row width="50%"}
- Las secuencias de MRI más útiles son la T2 para visualizar la anatomía y la colocación del aplicador.
- Secuencias adicionales como la T1 con contraste o la isotrópica 3D pueden proporcionar información complementaria.
:::

:::

::: notes

:::

## MRI vs CT: Cervix

::: {layout-ncol=2}

![](img/CervixCT.png){width=85%}

![](img/CervixMR.png){width=85%}

:::


## MRI vs CT: Aplicador

::: {layout-ncol=2}

![](img/CTFletcher.JPG){width=85%}

![](img/MRIFletcher.JPG){width=85%}

:::

::: notes
Volver a comentar la solución del registro vs reconstrucción directa. Hay que recordar que la adquisición de imágenes no se hace en el mismo lugar ni al mismo tiempo.
:::

## ¿Qué es la reconstrucción de aplicadores?

::: columns
::: {.column width="50%"}
![](img/EsquemaLigadura.png){width="100%"}
:::

::: {.column width="50%"}
![](img/Gastro.png){width="100%"}
:::
:::

La reconstrucción del aplicador es el proceso de identificar con precisión la ruta de la fuente dentro de los canales por donde circula la fuente, así como la primera posición de parada.

::: notes

:::

## Impacto en la distribución de dosis
::: columns

::: {.column width="50%"}
::: {style="display: inline-block; border: 1px solid black; padding: 5px;"}
![](img/EfectoIncertidumbrePosicionamiento.PNG){width="70%"}
:::
:::

::: {.column width="50%"}
Párametros de histograma

- Vejiga y recto en la dirección antero-posterior: 5%-6% por mm
- Resto: 4% por mm 


:::
:::


::: {.callout-warning}
El D2cc del recto es el parámetro más sensible a los desplazamientos, cambiando aproximadamente un 10% por cambio de ±1.5 mm.
:::

::: notes
Incidir en la importancia de la reconstrucción de los aplicadores
:::

## Modos de reconstrucción

- Reconstrucción directa
- Reconstrucción mediante bibliotecas
- Planes híbridos

::: notes

:::

## Reconstrucción directa

- El objetivo es encontrar el conjunto discreto de puntos de parada de la fuente en el sistema de referencia de la secuencia de imágenes.

- Por otro lado, hemos de hacer corresponder univocamente dichas coordenadas a un parámetro de longitud.

## Pros y contras de la reconstrucción directa

### Pros

- Como su nombre indica es la manera más directa para reconstruir el canal de una fuente.

### Contras

- Las trayectoria de la fuente puede no ser fácilmente identificable.
- El espesor de corte. 

::: notes

:::

# *Dummies* en MRI


::: notes

:::

## *Dummies* CT

::: {layout-ncol="2"}

![](img/dummies.jpg)

![](img/Dummies_bebig.jpg)


:::

::: notes
Hechas de materiales de Z alto
Son muy habituales y están codificadas para ver el primer punto de parada. Dificultad de cuando se cruzan dummies de varios canales y el artefacto a ser materiales de Z alto. 
:::


## *Dummies* MRI

::: {layout-ncol="3"}

![](img/DummiesMR_Image.jpg){width="85%"}

![](img/DummiesMR.png){width="100%"}

![](img/DummiesPepe.png){width="120%"}

:::

::: {.callout-note}
No hay *dummies* comerciales en el caso de agujas.
:::

::: notes
Hechas de materiales con "hidrógenos"(Por la resonancia)
Al ser líquidos, problemas de contrucción. De ahí la dificultad para las agujas.
:::

## *Dummies* puntuales

::: {style="display: inline-block; border: 1px solid black; padding: 5px;"}
![](img/richat2015.png)
:::

::: {layout-ncol="2"}

![](img/auxina.jpg){width="50%"}

![](img/pellets1.png){width="100%"}


:::


::: notes

:::

# Bibliotecas de aplicadores

::: notes

:::

## ¿Qué son las bibliotecas de aplicadores?

- El objetivo de la reconstrucción es la de encontrar la transformación lineal que ha de aplicarse a un modelo para que quede superpuesto sobre la imagen.

- En contraposición a la reconstrucción directa, no es necesario conocer completamente la trayectoria de la fuente y la primera posición de parada.

- Es útil unicamente en aplicadores rígidos


::: notes

:::

## Bibliotecas de aplicadores

::: {layout-nrow=2}
### Oncentra {.row width="50%"}

![](img/biboncentra2.jpg){fig-align="center" width="40%"}



### Sagiplan {.center .row width="50%"}

::: columns

::: {.column width="50%"}
![](img/biblsagiplan1.jpg){fig-align="center" width="40%"}
:::

::: {.column width="50%"}
![](img/biblsagiplan2.jpg){fig-align="center" width="30%"}
:::
:::

:::

::: notes

:::


## Transformaciones lineales

\begin{align}

P=
\begin{pmatrix}
R &  \vec{t}\\
0 &  1\\
\end{pmatrix}

\ \

R=
\begin{pmatrix}
r_{xx} & r_{xy} & r_{xz} \\
r_{yx} & r_{yy} & r_{yz} \\
r_{zx} & r_{zy} & r_{zz} \\
\end{pmatrix}

\ \

\vec{t}=
\begin{pmatrix}
t_{x} \\
t_{y} \\
t_{z} \\
\end{pmatrix}

\end{align}

\begin{align}

P_1 P_2=
\begin{pmatrix}
R_1 &  \vec{t_1}\\
0 &  1\\
\end{pmatrix}
\begin{pmatrix}
R_2 &  \vec{t_2}\\
0 &  1\\
\end{pmatrix}=
\begin{pmatrix}
R_1 R_2 & R1 \vec{t_2}+ \vec{t_1}\\
0 &  1\\
\end{pmatrix}


\end{align}

\begin{align}

R R^T=\mathbb{I}

\rightarrow

P^{-1}=
\begin{pmatrix}
R^T &  -R^{T}\vec{t}\\
0 &  1\\
\end{pmatrix}

\end{align}

::: notes

:::

## Ejemplo de esquema del aplicador

```{mermaid}

graph TD;
    id0(Rule)-->id1(189722-04A<br>Fijación);
    id1--OVOID1FIX-->id2_1(189735-06<br>Canal derecho);
    id1--IUFIX-->id2_2(IU elegida);
    id1--OVOID2FIX-->id2_3(189740-06<br>Canal izquierdo);
    id2_1--OVOIDRI-->id3_1_4(Ovoide<br>derecho)
    id2_3--OVOIDRI-->id3_3_4(Ovoide<br>izquierdo)
```

## Equivalencia en la Biblioteca

::: {layout-nrow=2}
### Oncentra

```XML
<connector name="OVOIDRI">
  <centerPoint x="39.2329311043" y="-8.287564434702" z="264.9381801444" />
  <axisDirection x="-0.08682408883347" y="0.8660254037844" z="-0.4924038765061" />
  <referenceDirection x="0.1503837331804" y="0.5" z="0.8528685319524" />
</connector>
```

### Sagiplan 

```XML
<Applicator>
[...]
  <Matrix>
    <M00>1.51522653757651060E-01</M00>
    <M01>-9.87841876892012416E-01</M01>
    <M02>3.47751586150990138E-02</M02>
    <M03>-1.25793160108370663E+05</M03>
    <M10>4.88627086188037407E-01</M10>
[...]
  </Matrix>
[...]
</Applicator>
```
:::

::: notes

:::

## Piezas sin transformación

```{python}
import trimesh
import numpy as np
import matplotlib.pyplot as plt
from matplotlib.path import Path
#ImagenEntrada=trimesh.load('stl/VienaPellets.stl')
CD=trimesh.load('stl/utrecht/CD.stl')
CI=trimesh.load('stl/utrecht/CI.stl')
OD=trimesh.load('stl/utrecht/OD.stl')
OI=trimesh.load('stl/utrecht/OI.stl')
IU=trimesh.load('stl/utrecht/IU.stl')
SP=trimesh.load('stl/utrecht/SP.stl')
scene = trimesh.Scene()
scene.add_geometry(CD)
scene.add_geometry(CI)
scene.add_geometry(IU)
scene.add_geometry(SP)
scene.add_geometry(OI)
scene.add_geometry(OD)
scene.show()
```

## Modelo completo

```{python}
import trimesh
import numpy as np
import matplotlib.pyplot as plt
from matplotlib.path import Path
#ImagenEntrada=trimesh.load('stl/VienaPellets.stl')
CD=trimesh.load('stl/utrecht/CD_T.stl')
CI=trimesh.load('stl/utrecht/CI_T.stl')
OD=trimesh.load('stl/utrecht/OD_T.stl')
OI=trimesh.load('stl/utrecht/OI_T.stl')
IU=trimesh.load('stl/utrecht/IU_T.stl')
SP=trimesh.load('stl/utrecht/SP_T.stl')
scene = trimesh.Scene()
scene.add_geometry(CD)
scene.add_geometry(CI)
scene.add_geometry(IU)
scene.add_geometry(SP)
scene.add_geometry(OI)
scene.add_geometry(OD)
scene.show()
```


# Publicación 1

![](img/librerias-1.png)

::: notes
Notes
:::

## Objetivos


::: columns

::: {.column width="50%"}
![](img/utrecht.jpg){fig-align="center" width="100%"}
:::

::: {.column width="50%"}
![](img/TB_bg.png){fig-align="center" width="100%"}
:::
:::


## Material y métodos I

```{python}
import trimesh
import numpy as np
import matplotlib.pyplot as plt
from matplotlib.path import Path
#ImagenEntrada=trimesh.load('stl/VienaPellets.stl')
ND=trimesh.load('stl/utrecht/ND_sola.stl')
neeedle_color = [1.0, 0.5, 0.0, 1.0]
ND.visual.face_colors = neeedle_color
scene = trimesh.Scene()
scene.add_geometry(ND)
scene.show()
```


## Material y métodos II

::: {layout-nrow=2}
![](img/freecad_tb1.png){width=100%}

![](img/freecad_tb2.png){width=50%}

![](img/freecad_tb3.png){width=75%}

![](img/freecad_logo.png)
:::


## Material y métodos III

{{< video https://www.youtube.com/embed/AhJ1L-rfLtY?&autoplay=1&playlist=AhJ1L-rfLtY&loop=1&mute=1&hl=en&answer=140174 width="1100" height="600" >}}


## Resultados I

::: columns

::: {.column width=50%}
![](img/utrecht_virtual.jpg)
:::

::: {.column width=50%}
![](img/benidorm_virtual.png)
:::

:::

## Resultados II 

::: columns

::: {.column width="50%"}

### Utrecht

```{mermaid}
graph TD;
    id0(Rule)-->id1(189722-04A<br>Fijación);
    id1--OVOID1FIX-->id2_1(189735-06<br>Canal derecho);
    id1--IUFIX-->id2_2(IU elegida);
    id1--OVOID2FIX-->id2_3(189740-06<br>Canal izquierdo);
    id2_1--NEEDLE1-->id3_1_1(Aguja 1)
    id2_1--NEEDLE2-->id3_1_2(Aguja 2)
    id2_1--NEEDLE3-->id3_1_3(Aguja 3)
    id2_1--OVOIDRI-->id3_1_4(Ovoide<br>derecho)
    id2_3--NEEDLE1-->id3_3_1(Aguja 1)
    id2_3--NEEDLE2-->id3_3_2(Aguja 2)
    id2_3--NEEDLE3-->id3_3_3(Aguja 3)
    id2_3--OVOIDRI-->id3_3_4(Ovoide<br>izquierdo)
```
:::

::: {.column width="50%"}

### Benidorm

```{mermaid}
graph TD;
    id0(Rule)-->id1(201722-04A<br>Fijación);
    id1--CYLINDER-->id2_1(Cilindro elegido);
    id1--IUFIX-->id2_2(IU elegida);
    id1--NEEDLE1-->id2_3_1(Aguja 1)
    id1--NEEDLE2-->id2_3_2(Aguja 2)
    id1--NEEDLE3-->id2_3_3(Aguja 3)
    id1-->id2_3_4([...])
    id1--NEEDLEX-->id2_3_X(Aguja X)
```
:::
:::


## Discusión

# Publicación 2

![](img/preplan-1.png)

::: notes
Notes
:::

## Objetivos

## Material y métodos

## Resultados

## Discusión

# Publicación 3

![](img/cancers-01.png)

::: notes
Notes
:::

## Objetivos



## Material y métodos

## Resultados

## Discusión

# Discusión


::: notes
Notes
:::


# Conclusiones


::: notes
Notes
:::
